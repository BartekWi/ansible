---
- name: Playbook do aktualizacji Debian (z obsługą host down)
  hosts: agh
  become: yes
  gather_facts: no
  tasks:
    # 1. Sprawdzenie czy host żyje (bez przerywania playbooka)
    - name: Sprawdź czy host jest dostępny (port 22)
      delegate_to: localhost
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        timeout: 15
        state: started
      ignore_errors: yes
      register: host_status
      become: no # Sprawdzanie portu nie wymaga roota na localhost

    # 2. Powiadomienie o braku połączenia (uruchamiane na localhost)
    - name: Powiadomienie o BŁĘDZIE - Host niedostępny (Discord)
      community.general.discord:
        webhook_id: "{{ discord_id }}"
        webhook_token: "{{ discord_token }}"
        username: Semaphore
        content: "❌ [CRITICAL] Nie można połączyć się z {{ inventory_hostname }}. Serwer jest wyłączony lub sieć nie działa."
      delegate_to: localhost
      become: no
      when: host_status.failed
    - name: Zakończ playbook jeśli host nie odpowiada
      meta: end_play
      when: host_status.failed  
    - name: Zbierz fakty o systemie (ręcznie)
      setup:

    - name: Blok aktualizacji z obsługą błędów 
      block:
        - name: Zaktualizuj wszystkie pakiety do najnowszej wersji - "apt-get upgrade"
          apt:
            upgrade: safe
            update_cache: yes
            autoclean: true
            clean: true
            autoremove: true
            dpkg_options: 'force-confold,force-confdef'
          environment: 
            DEBIAN_FRONTEND: noninteractive
          register: upgradeapt
        - name: Powiadomienie o SUKCESIE (Discord)
          community.general.discord:
            webhook_id: "{{ discord_id }}"
            webhook_token: "{{ discord_token }}"
            username: Semaphore
            content: "✅ [SUKCES] Aktualizacja na {{ ansible_hostname }} zakończona.\nZmienione: {{ upgradeapt.changed }}"
      rescue:
        - name: Powiadomienie o BŁĘDZIE (Discord) - wymagane przez zadanie
          community.general.discord:
            webhook_id: "{{ discord_id }}"
            webhook_token: "{{ discord_token }}"
            username: Semaphore
            content: "Vg [BŁĄD] Aktualizacja na {{ ansible_hostname }} NIE POWIODŁA SIĘ! Sprawdź logi w Semaphore."
