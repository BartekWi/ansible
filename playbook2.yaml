---
- name: Sprawdzenie dostƒôpno≈õci hosta
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Sprawd≈∫ czy port SSH jest otwarty
      wait_for:
        host: agh
        port: 22
        state: started
        timeout: 5
      register: ssh_check
      ignore_errors: yes

    - name: Powiadomienie o B≈ÅƒòDZIE PO≈ÅƒÑCZENIA (Discord)
      community.general.discord:
        webhook_id: "{{ discord_id }}"
        webhook_token: "{{ discord_tokenk }}"
        username: Semaphore
        content: "üõë [B≈ÅƒÑD KRYTYCZNY] Serwer agh jest WY≈ÅƒÑCZONY lub niedostƒôpny! Aktualizacja niemo≈ºliwa."
      when: ssh_check is failed

    - name: Zako≈Ñcz playbook je≈õli host nie odpowiada
      meta: end_play
      when: ssh_check is failed
- name: Playbook do aktualizacji Debian
  hosts: agh
  become: yes
  gather_facts: yes

  tasks:
    - name: Blok aktualizacji z obs≈ÇugƒÖ b≈Çƒôd√≥w 
      block:
        - name: Zaktualizuj wszystkie pakiety do najnowszej wersji - "apt-get upgrade"
          apt:
            upgrade: safe
            update_cache: yes
            autoclean: true
            clean: true
            autoremove: true
            dpkg_options: 'force-confold,force-confdef'
          environment: 
            DEBIAN_FRONTEND: noninteractive
          register: upgradeapt
        - name: Powiadomienie o SUKCESIE (Discord)
          community.general.discord:
            webhook_id: "{{ discord_id }}"
            webhook_token: "{{ discord_tokenk }}"
            username: Semaphore
            content: "‚úÖ [SUKCES] Aktualizacja na {{ ansible_hostname }} zako≈Ñczona.\nZmienione: {{ upgradeapt.changed }}"
      rescue:
        - name: Powiadomienie o B≈ÅƒòDZIE (Discord) - wymagane przez zadanie
          community.general.discord:
            webhook_id: "{{ discord_id }}"
            webhook_token: "{{ discord_tokenk }}"
            username: Semaphore
            content: "Vg [B≈ÅƒÑD] Aktualizacja na {{ ansible_hostname }} NIE POWIOD≈ÅA SIƒò! Sprawd≈∫ logi w Semaphore."
