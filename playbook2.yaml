---
- name: Sprawdzenie dostępności hosta
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    # 1. Sprawdzenie czy host żyje (bez przerywania playbooka)
    - name: Sprawdź dostępność hosta (timeout 5s)
      wait_for_connection:
        timeout: 5
      ignore_errors: yes
      register: host_status

    # 2. Powiadomienie o braku połączenia (uruchamiane na localhost)
    - name: Powiadomienie o BŁĘDZIE POŁĄCZENIA (Host Offline)
      community.general.discord:
        webhook_id: "{{ discord_id }}" # Zmień to!
        webhook_token: "{{ discord_token }}"    # Zmień to!
        username: Semaphore
        content: "⛔ [BŁĄD KRYTYCZNY] Host {{ inventory_hostname }} jest OFFLINE. Aktualizacja niemożliwa."
      delegate_to: localhost  # Wykonaj to na serwerze Semaphore, nie na celu
      become: no
      when: host_status is failed
    - name: Zakończ działanie jeśli host offline
      meta: end_play
      when: host_status is failed
- name: Playbook do aktualizacji Debian
  hosts: agh
  become: yes
  gather_facts: yes

  tasks:
    - name: Blok aktualizacji z obsługą błędów 
      block:
        - name: Zaktualizuj wszystkie pakiety do najnowszej wersji - "apt-get upgrade"
          apt:
            upgrade: safe
            update_cache: yes
            autoclean: true
            clean: true
            autoremove: true
            dpkg_options: 'force-confold,force-confdef'
          environment: 
            DEBIAN_FRONTEND: noninteractive
          register: upgradeapt
        - name: Powiadomienie o SUKCESIE (Discord)
          community.general.discord:
            webhook_id: "{{ discord_id }}"
            webhook_token: "{{ discord_token }}"
            username: Semaphore
            content: "✅ [SUKCES] Aktualizacja na {{ ansible_hostname }} zakończona.\nZmienione: {{ upgradeapt.changed }}"
      rescue:
        - name: Powiadomienie o BŁĘDZIE (Discord) - wymagane przez zadanie
          community.general.discord:
            webhook_id: "{{ discord_id }}"
            webhook_token: "{{ discord_token }}"
            username: Semaphore
            content: "Vg [BŁĄD] Aktualizacja na {{ ansible_hostname }} NIE POWIODŁA SIĘ! Sprawdź logi w Semaphore."
