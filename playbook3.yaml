---
- name: Playbook 3 - Kopia zapasowa AdGuard Home
  hosts: agh_servers  # Upewnij się, że ta nazwa grupy pasuje do Twojego inventory w Semaphore
  become: true
  vars:
    # Ścieżka instalacji AdGuard Home (dostosuj, jeśli zainstalowałeś w innym miejscu)
    agh_dir: "/adguardhome/AdGuardHome"
    # Katalog tymczasowy na serwerze AGH
    remote_temp_dir: "/tmp/agh_backups"
    # Katalog docelowy na serwerze Ansible (gdzie mają trafiać kopie)
    local_backup_dir: "/var/backups/agh_remote_backups"
    # Format nazwy pliku z datą
    backup_filename: "agh_backup_{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.tar.gz"

  tasks:
    - name: Rozpoczęcie procedury backupu (Block)
      block:
        - name: Upewnij się, że katalog tymczasowy istnieje na serwerze AGH
          ansible.builtin.file:
            path: "{{ remote_temp_dir }}"
            state: directory
            mode: '0700'

        - name: Zatrzymaj usługę AdGuard Home (dla spójności danych)
          ansible.builtin.service:
            name: AdGuardHome
            state: stopped

        - name: Stwórz archiwum z plikami konfiguracyjnymi i danymi
          community.general.archive:
            path:
              - "{{ agh_dir }}/AdGuardHome.yaml"
              - "{{ agh_dir }}/data"
            dest: "{{ remote_temp_dir }}/{{ backup_filename }}"
            format: gz

        - name: Uruchom ponownie usługę AdGuard Home
          ansible.builtin.service:
            name: AdGuardHome
            state: started

        - name: Pobierz kopię zapasową na serwer Ansible (Control Node)
          ansible.builtin.fetch:
            src: "{{ remote_temp_dir }}/{{ backup_filename }}"
            dest: "{{ local_backup_dir }}/"
            flat: yes

        - name: Usuń tymczasowe archiwum z serwera AGH (sprzątanie)
          ansible.builtin.file:
            path: "{{ remote_temp_dir }}/{{ backup_filename }}"
            state: absent

      rescue:
        - name: Powiadomienie o BŁĘDZIE (Discord) - wymagane przez zadanie
          community.general.discord:
            webhook_id: "{{ discord_id }}"
            webhook_token: "{{ discord_token }}"
            username: Semaphore
            content: "BŁĄD: Nie udało się wykonać kopii zapasowej AdGuard Home na serwerze {{ inventory_hostname }}."
