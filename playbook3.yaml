---
- name: Playbook 3 - Kopia zapasowa AdGuard Home
  hosts: agh  
  become: true
  gather_facts: no
  vars:
    agh_dir: "/adguardhome/AdGuardHome"
    remote_temp_dir: "/tmp/agh_backups"
    local_backup_dir: "/tmp/agh_remote_backups"
    backup_filename: "agh_backup_{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.tar.gz"
  tasks:
    - name: Sprawdź czy host jest dostępny (port 22)
      delegate_to: localhost
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 5
        state: started
      ignore_errors: yes
      register: host_status
      become: no 
    - name: Powiadomienie o BŁĘDZIE - Host niedostępny (Discord)
      community.general.discord:
        webhook_id: "{{ discord_id }}"
        webhook_token: "{{ discord_token }}"
        username: Semaphore
        content: "Nie można połączyć się z {{ inventory_hostname }}."
      delegate_to: localhost
      become: no
      when: host_status.failed
    - name: Zakończ jeśli host nie odpowiada
      meta: end_play
      when: host_status.failed  
    - name: Zbierz fakty o systemie
      setup:
    - name: Backup
      block:
        - name: Upewnienie się, czy katalog tymczasowy istnieje na serwerze AGH
          ansible.builtin.file:
            path: "{{ remote_temp_dir }}"
            state: directory
            mode: '0700'

        - name: Zatrzymanie usługi AdGuard Home 
          ansible.builtin.service:
            name: AdGuardHome
            state: stopped

        - name: Stworzenie archiwum z plikami konfiguracyjnymi i danymi
          community.general.archive:
            path:
              - "{{ agh_dir }}/AdGuardHome.yaml"
              - "{{ agh_dir }}/data"
            dest: "{{ remote_temp_dir }}/{{ backup_filename }}"
            format: gz

        - name: Ponowne uruchomienie usługi
          ansible.builtin.service:
            name: AdGuardHome
            state: started

        - name: Pobranie kopii zapasowej na serwer Ansible
          ansible.builtin.fetch:
            src: "{{ remote_temp_dir }}/{{ backup_filename }}"
            dest: "{{ local_backup_dir }}/"
            flat: yes

        - name: Usuniećie tymczasowego archiwum z serwera AGH
          ansible.builtin.file:
            path: "{{ remote_temp_dir }}/{{ backup_filename }}"
            state: absent

      rescue:
        - name: Powiadomienie o błedzie
          community.general.discord:
            webhook_id: "{{ discord_id }}"
            webhook_token: "{{ discord_token }}"
            username: Semaphore
            content: "Nie udało się wykonać kopii zapasowej"
