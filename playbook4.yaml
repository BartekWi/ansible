---
- name: Konfiguracja Serwera Windows (Storage, Users, Shares, Software)
  hosts: windows  # Lub nazwa grupy z inventory, np. 'windows'
  gather_facts: no
  vars:
    # ZMIEŃ TO NA SWOJE NAZWISKO
    nazwisko: "Wiecek" 
    
    # Nazwy dynamiczne
    group_name: "Kierownicy_{{ nazwisko }}"
    share_name: "Projekty_{{ nazwisko }}"
    share_path: "F:\\Projekty"

  tasks:

    # -------------------------------------------------------------------
    # ZADANIE 1: Konfiguracja Puli Dyskowej, Tieringu i Woluminu (F:)
    # Używamy PowerShell, ponieważ natywne moduły Ansible mają ograniczone
    # wsparcie dla Storage Tiering i Storage Spaces w konfiguracji mieszanej.
    # -------------------------------------------------------------------
    - name: Utworzenie Puli, Warstw (Tiers) i Woluminu Tiered
      ansible.windows.win_shell: |
        # 1. Sprawdzenie idempotentności - czy dysk F: już istnieje
        if (Get-Volume -DriveLetter F -ErrorAction SilentlyContinue) {
            Write-Host "Wolumin F: już istnieje. Pomijam konfigurację."
            Exit 0
        }

        # 2. Pobranie dysków fizycznych (zakładamy, że MediaType jest już ustawiony poprawnie na poziomie VM)
        $disks = Get-PhysicalDisk -CanPool $true

        if ($disks.Count -lt 4) {
            Write-Error "Błąd: Wymagane 4 dyski (2xSSD, 2xHDD) nie są dostępne w stanie CanPool."
            Exit 1
        }

        # 3. Utworzenie Puli Dyskowej
        $poolName = "StoragePool_{{ nazwisko }}"
        New-StoragePool -FriendlyName $poolName `
                        -StorageSubsystemFriendlyName "Windows Storage*" `
                        -PhysicalDisks $disks | Out-Null

        # 4. Utworzenie definicji Warstw (Storage Tiers) - TO JEST KLUCZOWE DLA TIERINGU
        # Tworzymy warstwę szybką (SSD) i pojemną (HDD)
        # Używamy Mirror dla obu, aby zapewnić redundancję 
        
        $tierSSD = New-StorageTier -StoragePoolFriendlyName $poolName `
                                   -FriendlyName "SSD_Tier" `
                                   -MediaType SSD `
                                   -ResiliencySettingName Mirror

        $tierHDD = New-StorageTier -StoragePoolFriendlyName $poolName `
                                   -FriendlyName "HDD_Tier" `
                                   -MediaType HDD `
                                   -ResiliencySettingName Mirror

        # 5. Obliczenie maksymalnej dostępnej wielkości dla obu warstw
        # Wymóg: "Dysk wirtualny ma obejmować całą dostępną przestrzeń w puli" 
        
        $tierSizes = Get-StorageTierSupportedSize -FriendlyName "SSD_Tier", "HDD_Tier"
        
        $sizeSSD = ($tierSizes | Where-Object FriendlyName -eq "SSD_Tier").TierSizeMax
        $sizeHDD = ($tierSizes | Where-Object FriendlyName -eq "HDD_Tier").TierSizeMax

        # 6. Utworzenie Dysku Wirtualnego korzystającego z obu warstw
        $vDisk = New-VirtualDisk -StoragePoolFriendlyName $poolName `
                                 -FriendlyName "TieredDisk_{{ nazwisko }}" `
                                 -StorageTiers @($tierSSD, $tierHDD) `
                                 -StorageTierSizes @($sizeSSD, $sizeHDD) `
                                 -WriteCacheSize 0

        # 7. Inicjalizacja i formatowanie (ReFS, litera F:) 
        $vDisk | Initialize-Disk -PartitionStyle GPT -PassThru | `
                 New-Partition -DriveLetter F -UseMaximumSize | `
                 Format-Volume -FileSystem ReFS -NewFileSystemLabel "Data" -Confirm:$false

      register: storage_result
      changed_when: "'Wolumin F: już istnieje' not in storage_result.stdout"
        

    # -------------------------------------------------------------------
    # ZADANIE 2: Zarządzanie Użytkownikami i Grupami

    # -------------------------------------------------------------------
    - name: Utwórz użytkownika Marek Romanek
      ansible.windows.win_user:
        name: "Marek Romanek"
        password: "Password123!" # Zalecane użycie Ansible Vault w produkcji
        state: present
        groups: Users

    - name: Utwórz użytkownika Jacek Gula
      ansible.windows.win_user:
        name: "Jacek Gula"
        password: "Password123!"
        state: present
        groups: Users

    - name: Utwórz grupę zabezpieczeń '{{ group_name }}'
      ansible.windows.win_group:
        name: "{{ group_name }}"
        state: present
        description: "Grupa kierownikow projektu"

    - name: Dodaj użytkowników do grupy '{{ group_name }}'
      ansible.windows.win_group_membership:
        name: "{{ group_name }}"
        members:
          - "Marek Romanek"
          - "Jacek Gula"
        state: present

    # -------------------------------------------------------------------
    # ZADANIE 3: Katalogi i Udziały Sieciowe

    # -------------------------------------------------------------------
    - name: Utwórz katalog '{{ share_path }}' na dysku F
      ansible.windows.win_file:
        path: "{{ share_path }}"
        state: directory

    - name: Udostępnij katalog jako '{{ share_name }}' z uprawnieniami
      ansible.windows.win_share:
        name: "{{ share_name }}"
        path: "{{ share_path }}"
        list: yes
        full: "Administrators,{{ group_name }}" # Pełny dostęp dla Adminów i Kierowników
        read: "" # Brak dostępu dla innych (domyślnie Everyone ma read, tutaj usuwamy)
        state: present

    # Dodatkowe zabezpieczenie NTFS (oprócz uprawnień udziału, ważne są uprawnienia plików)
    - name: Ustaw uprawnienia NTFS dla katalogu Projekty
      ansible.windows.win_acl:
        path: "{{ share_path }}"
        user: "{{ group_name }}"
        rights: FullControl
        type: allow
        state: present

    # -------------------------------------------------------------------
    # ZADANIE 4: Instalacja Aplikacji (Winget)

    # -------------------------------------------------------------------
    - name: Zainstaluj aplikacje przez Winget (7zip, Firefox, BIND/dig)
      ansible.windows.win_shell: |
        $app = "{{ item.id }}"
        if (!(winget list -e --id $app)) {
            winget install --id $app -e --silent --accept-package-agreements --accept-source-agreements
        }
      loop:
        - { name: '7zip', id: '7zip.7zip' }
        - { name: 'Firefox', id: 'Mozilla.Firefox' }
        - { name: 'BIND Tools (dig)', id: 'ISC.BIND' } # Pakiet zawierający narzędzie dig
      register: winget_install
      changed_when: winget_install.stdout is search("Successfully installed")

    # -------------------------------------------------------------------
    # ZADANIE 5: Rejestr - Blokada usuwania drukarek

    # -------------------------------------------------------------------
    - name: Konfiguracja Rejestru - Zapobieganie usuwaniu drukarek
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
        name: NoDeletePrinter
        data: 1
        type: dword
        state: present
      # Nota: Ta polityka systemowa blokuje usuwanie drukarek użytkownikom, 
      # ale system Windows domyślnie pozwala Administratorom ignorować to ustawienie,
      # co spełnia wymóg "tylko wszystkim użytkownikom nie posiadających uprawnień administracyjnych".
