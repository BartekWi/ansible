---
- name: Konfiguracja Serwera Windows (Storage, Users, Shares, Software)
  hosts: windows  # Lub nazwa grupy z inventory, np. 'windows'
  gather_facts: no
  vars:
    # Nazwy dynamiczne
    group_name: "Kierownicy_Wiecek"
    share_name: "Projekty_Wiecek"
    share_path: "F:\\Projekty"

  tasks:

    # -------------------------------------------------------------------
    # ZADANIE 1: Konfiguracja Puli Dyskowej, Tieringu i Woluminu (F:)
  
    # Używamy PowerShell, ponieważ natywne moduły Ansible mają ograniczone
    # wsparcie dla Storage Tiering i Storage Spaces w konfiguracji mieszanej.
    # -------------------------------------------------------------------
    # -------------------------------------------------------------------
    # ZADANIE 1: Konfiguracja Puli Dyskowej z wymuszeniem typów SSD/HDD
    # -------------------------------------------------------------------
    - name: Konfiguracja Storage Pool, Wymuszenie MediaType i Woluminu
      ansible.windows.win_shell: |
        # 1. Sprawdzenie czy konfiguracja już istnieje (Idempotentność)
        if (Get-Volume -DriveLetter F -ErrorAction SilentlyContinue) {
            Write-Host "Wolumin F: już istnieje. Kończę działanie."
            Exit 0
        }

        # 2. Pobranie dostępnych surowych dysków
        $disks = Get-PhysicalDisk -CanPool $true | Sort-Object DeviceId

        # Sprawdzenie czy mamy wymagane 4 dyski (zgodnie z wymogami projektu)
        if ($disks.Count -lt 4) {
            Write-Error "BŁĄD: Znaleziono tylko $($disks.Count) dysków 'CanPool'. Wymagane są 4 (2xSSD, 2xHDD)."
            Exit 1
        }

        # 3. HACK dla maszyn wirtualnych: Ręczne oznaczanie typów mediów
        # Ponieważ wszystkie dyski mają 20GB, bierzemy pierwsze 2 jako SSD, resztę jako HDD.
        # Bez tego Windows w VM widzi je jako "Unspecified" i nie zrobi Tieringu.


        # 4. Utworzenie Puli Dyskowej (z rozpoznanymi już typami SSD/HDD)
        $poolName = "StoragePool_Wiecek"
        New-StoragePool -FriendlyName $poolName `
                        -StorageSubsystemFriendlyName "Windows Storage*" `
                        -PhysicalDisks $disks | Out-Null

        # 5. Utworzenie Wirtualnego Dysku z Tieringiem
        # Windows Server automatycznie tworzy tiery (Performance/Capacity), 
        # gdy w puli są różne typy dysków (SSD+HDD).
        
        # Tworzymy dysk w trybie Mirror (wymaga min. 2 dysków w każdej warstwie, co mamy spełnione)
        $vDisk = New-VirtualDisk -StoragePoolFriendlyName $poolName `
                                 -FriendlyName "TieredDisk_Wiecek" `
                                 -ResiliencySettingName Mirror `
                                 -UseMaximumSize `
                                 -ProvisioningType Fixed

        # 6. Inicjalizacja, partycja i formatowanie ReFS (litera F:)
        $vDisk | Initialize-Disk -PartitionStyle GPT -PassThru | `
                 New-Partition -DriveLetter F -UseMaximumSize | `
                 Format-Volume -FileSystem ReFS -NewFileSystemLabel "ProjektyData" -Confirm:$false
                 
      register: storage_setup
      changed_when: "'Wolumin F: już istnieje' not in storage_setup.stdout"

    # -------------------------------------------------------------------
    # ZADANIE 2: Zarządzanie Użytkownikami i Grupami
   
    # -------------------------------------------------------------------
    - name: Utwórz użytkownika Marek Romanek
      ansible.windows.win_user:
        name: "Marek Romanek"
        password: "Password123!" # Zalecane użycie Ansible Vault w produkcji
        state: present
        groups: Users

    - name: Utwórz użytkownika Jacek Gula
      ansible.windows.win_user:
        name: "Jacek Gula"
        password: "Password123!"
        state: present
        groups: Users

    - name: Utwórz grupę zabezpieczeń '{{ group_name }}'
      ansible.windows.win_group:
        name: "{{ group_name }}"
        state: present
        description: "Grupa kierownikow projektu"

    - name: Dodaj użytkowników do grupy '{{ group_name }}'
      ansible.windows.win_group_membership:
        name: "{{ group_name }}"
        members:
          - "Marek Romanek"
          - "Jacek Gula"
        state: present

    # -------------------------------------------------------------------
    # ZADANIE 3: Katalogi i Udziały Sieciowe
    
    # -------------------------------------------------------------------
    - name: Utwórz katalog '{{ share_path }}' na dysku F
      ansible.windows.win_file:
        path: "{{ share_path }}"
        state: directory

    - name: Udostępnij katalog jako '{{ share_name }}' z uprawnieniami
      ansible.windows.win_share:
        name: "{{ share_name }}"
        path: "{{ share_path }}"
        list: yes
        full: "Administrators,{{ group_name }}" # Pełny dostęp dla Adminów i Kierowników
        read: "" # Brak dostępu dla innych (domyślnie Everyone ma read, tutaj usuwamy)
        state: present

    # Dodatkowe zabezpieczenie NTFS (oprócz uprawnień udziału, ważne są uprawnienia plików)
    - name: Ustaw uprawnienia NTFS dla katalogu Projekty
      ansible.windows.win_acl:
        path: "{{ share_path }}"
        user: "{{ group_name }}"
        rights: FullControl
        type: allow
        state: present

    # -------------------------------------------------------------------
    # ZADANIE 4: Instalacja Aplikacji (Winget)
    
    # -------------------------------------------------------------------
    - name: Zainstaluj aplikacje przez Winget (7zip, Firefox, BIND/dig)
      ansible.windows.win_shell: |
        $app = "{{ item.id }}"
        if (!(winget list -e --id $app)) {
            winget install --id $app -e --silent --accept-package-agreements --accept-source-agreements
        }
      loop:
        - { name: '7zip', id: '7zip.7zip' }
        - { name: 'Firefox', id: 'Mozilla.Firefox' }
        - { name: 'BIND Tools (dig)', id: 'ISC.BIND' } # Pakiet zawierający narzędzie dig
      register: winget_install
      changed_when: winget_install.stdout is search("Successfully installed")

    # -------------------------------------------------------------------
    # ZADANIE 5: Rejestr - Blokada usuwania drukarek
 
    # -------------------------------------------------------------------
    - name: Konfiguracja Rejestru - Zapobieganie usuwaniu drukarek
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
        name: NoDeletePrinter
        data: 1
        type: dword
        state: present
      # Nota: Ta polityka systemowa blokuje usuwanie drukarek użytkownikom, 
      # ale system Windows domyślnie pozwala Administratorom ignorować to ustawienie,
      # co spełnia wymóg "tylko wszystkim użytkownikom nie posiadających uprawnień administracyjnych".
