---
- name: Konfiguracja Serwera Windows (Storage, Users, Shares, Software)
  hosts: all
  gather_facts: no
  vars:
    # ZMIEŃ TO NA SWOJE NAZWISKO
    nazwisko: "Wiecek" 
    
    # Nazwy dynamiczne
    group_name: "Kierownicy_{{ nazwisko }}"
    share_name: "Projekty_{{ nazwisko }}"
    share_path: "F:\\Projekty"

  tasks:

    # -------------------------------------------------------------------
    # ZADANIE 1: Konfiguracja Puli Dyskowej z jawnym Tieringiem (SSD+HDD)
    # -------------------------------------------------------------------
    - name: Utworzenie Puli, Warstw (Tiers) i Woluminu Tiered
      ansible.windows.win_shell: |
        # WAŻNE: Wymuszenie zatrzymania skryptu w przypadku jakiegokolwiek błędu
        $ErrorActionPreference = "Stop"

        # 1. Sprawdzenie idempotentności - czy dysk F: już istnieje
        if (Get-Volume -DriveLetter F -ErrorAction SilentlyContinue) {
            Write-Host "Wolumin F: już istnieje. Pomijam konfigurację."
            Exit 0
        }

        # 2. Pobranie dysków fizycznych
        # Upewnij się, że w VM dodałeś 4 dyski i ustawiłeś im MediaType (SSD/HDD)
        $disks = Get-PhysicalDisk -CanPool $true

        if ($disks.Count -lt 4) {
            # Wypiszemy dokładną listę znalezionych dysków, aby ułatwić debugowanie
            $found = Get-PhysicalDisk -CanPool $true | Select FriendlyName, MediaType, Size, CanPool
            Write-Output $found
            Throw "BŁĄD: Znaleziono tylko $($disks.Count) dysków 'CanPool'. Wymagane są 4 (2xSSD, 2xHDD)."
        }

        # 3. Utworzenie Puli Dyskowej
        $poolName = "StoragePool_{{ nazwisko }}"
        New-StoragePool -FriendlyName $poolName `
                        -StorageSubsystemFriendlyName "Windows Storage*" `
                        -PhysicalDisks $disks | Out-Null

        # 4. Utworzenie definicji Warstw (Storage Tiers)
        # [cite_start]Tworzymy warstwę szybką (SSD) i pojemną (HDD) z Mirroringiem [cite: 13]
        
        $tierSSD = New-StorageTier -StoragePoolFriendlyName $poolName `
                                   -FriendlyName "SSD_Tier" `
                                   -MediaType SSD `
                                   -ResiliencySettingName Mirror

        $tierHDD = New-StorageTier -StoragePoolFriendlyName $poolName `
                                   -FriendlyName "HDD_Tier" `
                                   -MediaType HDD `
                                   -ResiliencySettingName Mirror

        # 5. Obliczenie maksymalnej dostępnej wielkości
        # [cite_start]Wymóg: "Dysk wirtualny ma obejmować całą dostępną przestrzeń w puli" [cite: 14]
        
        $tierSizes = Get-StorageTierSupportedSize -FriendlyName "SSD_Tier", "HDD_Tier"
        
        $sizeSSD = ($tierSizes | Where-Object FriendlyName -eq "SSD_Tier").TierSizeMax
        $sizeHDD = ($tierSizes | Where-Object FriendlyName -eq "HDD_Tier").TierSizeMax

        # 6. Utworzenie Dysku Wirtualnego (Tiered)
        $vDisk = New-VirtualDisk -StoragePoolFriendlyName $poolName `
                                 -FriendlyName "TieredDisk_{{ nazwisko }}" `
                                 -StorageTiers @($tierSSD, $tierHDD) `
                                 -StorageTierSizes @($sizeSSD, $sizeHDD) `
                                 -WriteCacheSize 0

        # [cite_start]7. Inicjalizacja i formatowanie (ReFS, litera F:) [cite: 14]
        $vDisk | Initialize-Disk -PartitionStyle GPT -PassThru | `
                 New-Partition -DriveLetter F -UseMaximumSize | `
                 Format-Volume -FileSystem ReFS -NewFileSystemLabel "ProjektyData" -Confirm:$false

      register: storage_result
      changed_when: "'Wolumin F: już istnieje' not in storage_result.stdout"

    # -------------------------------------------------------------------
    # ZADANIE 1.5: Czekanie na pojawienie się dysku (Fix na Twój błąd)
    # -------------------------------------------------------------------
    - name: Czekaj na dostępność dysku F
      ansible.windows.win_shell: |
        $retry = 0
        while (-not (Test-Path F:\)) {
            if ($retry -gt 10) { Throw "Timeout: Dysk F: nie pojawił się po utworzeniu." }
            Start-Sleep -Seconds 2
            $retry++
        }
        Write-Host "Dysk F: jest gotowy."

    # -------------------------------------------------------------------
    # [cite_start]ZADANIE 2: Zarządzanie Użytkownikami i Grupami [cite: 14, 15]
    # -------------------------------------------------------------------
    - name: Utwórz użytkownika Marek Romanek
      ansible.windows.win_user:
        name: "Marek Romanek"
        password: "Password123!"
        state: present
        groups: Users

    - name: Utwórz użytkownika Jacek Gula
      ansible.windows.win_user:
        name: "Jacek Gula"
        password: "Password123!"
        state: present
        groups: Users

    - name: Utwórz grupę zabezpieczeń '{{ group_name }}'
      ansible.windows.win_group:
        name: "{{ group_name }}"
        state: present
        description: "Grupa kierownikow projektu"

    - name: Dodaj użytkowników do grupy '{{ group_name }}'
      ansible.windows.win_group_membership:
        name: "{{ group_name }}"
        members:
          - "Marek Romanek"
          - "Jacek Gula"
        state: present

    # -------------------------------------------------------------------
    # [cite_start]ZADANIE 3: Katalogi i Udziały Sieciowe [cite: 15, 16]
    # -------------------------------------------------------------------
    - name: Utwórz katalog '{{ share_path }}' na dysku F
      ansible.windows.win_file:
        path: "{{ share_path }}"
        state: directory

    - name: Udostępnij katalog jako '{{ share_name }}' z uprawnieniami
      ansible.windows.win_share:
        name: "{{ share_name }}"
        path: "{{ share_path }}"
        list: yes
        full: "Administrators,{{ group_name }}"
        read: ""
        state: present

    - name: Ustaw uprawnienia NTFS dla katalogu Projekty
      ansible.windows.win_acl:
        path: "{{ share_path }}"
        user: "{{ group_name }}"
        rights: FullControl
        type: allow
        state: present

    # -------------------------------------------------------------------
    # [cite_start]ZADANIE 4: Instalacja Aplikacji (Winget) [cite: 17]
    # -------------------------------------------------------------------
    - name: Zainstaluj aplikacje przez Winget (7zip, Firefox, BIND/dig)
      ansible.windows.win_shell: |
        $app = "{{ item.id }}"
        # Sprawdzamy czy winget jest dostępny (Windows Server 2025 powinien mieć go domyślnie, 2019/2022 czasem wymaga doinstalowania App Installer)
        if (!(Get-Command winget -ErrorAction SilentlyContinue)) {
            Write-Warning "Winget nie jest zainstalowany lub nie jest w PATH."
            Exit 0 
        }
        if (!(winget list -e --id $app)) {
            winget install --id $app -e --silent --accept-package-agreements --accept-source-agreements
        }
      loop:
        - { name: '7zip', id: '7zip.7zip' }
        - { name: 'Firefox', id: 'Mozilla.Firefox' }
        - { name: 'BIND Tools (dig)', id: 'ISC.BIND' }
      register: winget_install
      changed_when: winget_install.stdout is search("Successfully installed")

    # -------------------------------------------------------------------
    # [cite_start]ZADANIE 5: Rejestr - Blokada usuwania drukarek [cite: 17]
    # -------------------------------------------------------------------
    - name: Konfiguracja Rejestru - Zapobieganie usuwaniu drukarek
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
        name: NoDeletePrinter
        data: 1
        type: dword
        state: present
