---
- name: Konfiguracja Serwera Windows (Storage, Users, Shares, Software)
  hosts: windows
  gather_facts: no
  vars:
    # ZMIEŃ TO NA SWOJE NAZWISKO
    nazwisko: "Wiecek" 
    
    # Nazwy dynamiczne
    group_name: "Kierownicy_{{ nazwisko }}"
    share_name: "Projekty_{{ nazwisko }}"
    share_path: "F:\\Projekty"

  tasks:

    # -------------------------------------------------------------------
    # ZADANIE 1: Konfiguracja Puli Dyskowej z jawnym Tieringiem (SSD+HDD)
    # -------------------------------------------------------------------
    - name: Konfiguracja Storage Pool z czyszczeniem błędów i Tieringiem
      ansible.windows.win_shell: |
        $ErrorActionPreference = "Stop"
        $poolName = "StoragePool_{{ nazwisko }}"

        # --- KROK 0: AUTONAPRAWA (Czyszczenie po błędnych próbach) ---
        # Jeśli Pula istnieje, ale wolumin F: nie - usuwamy pulę, aby zacząć od nowa.
        $existingPool = Get-StoragePool -FriendlyName $poolName -ErrorAction SilentlyContinue
        $existingVol = Get-Volume -DriveLetter F -ErrorAction SilentlyContinue

        if ($existingPool -and -not $existingVol) {
            Write-Host "WYKRYTO NIESPÓJNOŚĆ: Pula istnieje, ale brak dysku F. Usuwanie starej puli..."
            # Usuń ewentualne wirtualne dyski w tej puli
            Get-VirtualDisk -StoragePoolFriendlyName $poolName -ErrorAction SilentlyContinue | Remove-VirtualDisk -Confirm:$false
            # Usuń pulę
            Remove-StoragePool -FriendlyName $poolName -Confirm:$false
            Write-Host "Stara pula usunięta. Czekam na zwolnienie dysków..."
            Start-Sleep -Seconds 5
        }

        # --- KROK 1: Idempotentność (Jeśli F: istnieje, kończymy) ---
        if (Get-Volume -DriveLetter F -ErrorAction SilentlyContinue) {
            Write-Host "Wolumin F: już istnieje. Pomijam konfigurację."
            Exit 0
        }

        # --- KROK 2: Sprawdzenie dysków ---
        $disks = Get-PhysicalDisk -CanPool $true
        if ($disks.Count -lt 4) {
            # Ostateczna próba resetu dysków, jeśli są zablokowane w innej puli "Primordial"
            Write-Warning "Znaleziono za mało dysków ($($disks.Count)). Próba odświeżenia..."
            Update-HostStorageCache
            Start-Sleep -Seconds 2
            $disks = Get-PhysicalDisk -CanPool $true
        }

        if ($disks.Count -lt 4) {
             Throw "BŁĄD KRYTYCZNY: Znaleziono tylko $($disks.Count) dysków 'CanPool'. Wymagane 4."
        }

        # --- KROK 3: Utworzenie Puli ---
        New-StoragePool -FriendlyName $poolName `
                        -StorageSubsystemFriendlyName "Windows Storage*" `
                        -PhysicalDisks $disks | Out-Null

        # --- KROK 4: Definicja Warstw (SSD/HDD) ---
        # Ważne: Tworzymy definicje warstw w nowej puli
        $tierSSD = New-StorageTier -StoragePoolFriendlyName $poolName `
                                   -FriendlyName "SSD_Tier" `
                                   -MediaType SSD `
                                   -ResiliencySettingName Mirror

        $tierHDD = New-StorageTier -StoragePoolFriendlyName $poolName `
                                   -FriendlyName "HDD_Tier" `
                                   -MediaType HDD `
                                   -ResiliencySettingName Mirror

        # --- KROK 5: Obliczenie rozmiaru (FIX NA BŁĄD INVALID PARAMETER) ---
        $tierSizes = Get-StorageTierSupportedSize -FriendlyName "SSD_Tier", "HDD_Tier"
        
        $rawSizeSSD = ($tierSizes | Where-Object FriendlyName -eq "SSD_Tier").TierSizeMax
        $rawSizeHDD = ($tierSizes | Where-Object FriendlyName -eq "HDD_Tier").TierSizeMax

        # Zmniejszamy rozmiar o ok. 512MB (bezpieczny margines na metadane/alignment)
        # Bez tego New-VirtualDisk rzuca "Invalid Parameter"
        $safeSizeSSD = $rawSizeSSD - 536870912 
        $safeSizeHDD = $rawSizeHDD - 536870912

        Write-Host "Rozmiar SSD Max: $rawSizeSSD, Użyty: $safeSizeSSD"
        Write-Host "Rozmiar HDD Max: $rawSizeHDD, Użyty: $safeSizeHDD"

        # --- KROK 6: Utworzenie Dysku Wirtualnego ---
        $vDisk = New-VirtualDisk -StoragePoolFriendlyName $poolName `
                                 -FriendlyName "TieredDisk_{{ nazwisko }}" `
                                 -StorageTiers @($tierSSD, $tierHDD) `
                                 -StorageTierSizes @($safeSizeSSD, $safeSizeHDD)
                                 # Usunąłem -WriteCacheSize 0, bo czasem powoduje konflikty

        # --- KROK 7: Formatowanie ---
        $vDisk | Initialize-Disk -PartitionStyle GPT -PassThru | `
                 New-Partition -DriveLetter F -UseMaximumSize | `
                 Format-Volume -FileSystem ReFS -NewFileSystemLabel "ProjektyData" -Confirm:$false

      register: storage_result

    # -------------------------------------------------------------------
    # [cite_start]ZADANIE 2: Zarządzanie Użytkownikami i Grupami [cite: 14, 15]
    # -------------------------------------------------------------------
    - name: Utwórz użytkownika Marek Romanek
      ansible.windows.win_user:
        name: "Marek Romanek"
        password: "Password123!"
        state: present
        groups: Users

    - name: Utwórz użytkownika Jacek Gula
      ansible.windows.win_user:
        name: "Jacek Gula"
        password: "Password123!"
        state: present
        groups: Users

    - name: Utwórz grupę zabezpieczeń '{{ group_name }}'
      ansible.windows.win_group:
        name: "{{ group_name }}"
        state: present
        description: "Grupa kierownikow projektu"

    - name: Dodaj użytkowników do grupy '{{ group_name }}'
      ansible.windows.win_group_membership:
        name: "{{ group_name }}"
        members:
          - "Marek Romanek"
          - "Jacek Gula"
        state: present

    # -------------------------------------------------------------------
    # [cite_start]ZADANIE 3: Katalogi i Udziały Sieciowe [cite: 15, 16]
    # -------------------------------------------------------------------
    - name: Utwórz katalog '{{ share_path }}' na dysku F
      ansible.windows.win_file:
        path: "{{ share_path }}"
        state: directory

    - name: Udostępnij katalog jako '{{ share_name }}' z uprawnieniami
      ansible.windows.win_share:
        name: "{{ share_name }}"
        path: "{{ share_path }}"
        list: yes
        full: "Administrators,{{ group_name }}"
        read: ""
        state: present

    - name: Ustaw uprawnienia NTFS dla katalogu Projekty
      ansible.windows.win_acl:
        path: "{{ share_path }}"
        user: "{{ group_name }}"
        rights: FullControl
        type: allow
        state: present

    # -------------------------------------------------------------------
    # [cite_start]ZADANIE 4: Instalacja Aplikacji (Winget) [cite: 17]
    # -------------------------------------------------------------------
    - name: Zainstaluj aplikacje przez Winget (7zip, Firefox, BIND/dig)
      ansible.windows.win_shell: |
        $app = "{{ item.id }}"
        # Sprawdzamy czy winget jest dostępny (Windows Server 2025 powinien mieć go domyślnie, 2019/2022 czasem wymaga doinstalowania App Installer)
        if (!(Get-Command winget -ErrorAction SilentlyContinue)) {
            Write-Warning "Winget nie jest zainstalowany lub nie jest w PATH."
            Exit 0 
        }
        if (!(winget list -e --id $app)) {
            winget install --id $app -e --silent --accept-package-agreements --accept-source-agreements
        }
      loop:
        - { name: '7zip', id: '7zip.7zip' }
        - { name: 'Firefox', id: 'Mozilla.Firefox' }
        - { name: 'BIND Tools (dig)', id: 'ISC.BIND' }
      register: winget_install
      changed_when: winget_install.stdout is search("Successfully installed")

    # -------------------------------------------------------------------
    # [cite_start]ZADANIE 5: Rejestr - Blokada usuwania drukarek [cite: 17]
    # -------------------------------------------------------------------
    - name: Konfiguracja Rejestru - Zapobieganie usuwaniu drukarek
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
        name: NoDeletePrinter
        data: 1
        type: dword
        state: present
