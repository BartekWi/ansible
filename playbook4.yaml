---
- name: Konfiguracja Serwera Windows (Storage, Users, Shares, Software)
  hosts: windows  # Lub nazwa grupy z inventory, np. 'windows'
  gather_facts: no
  vars:
    # Nazwy dynamiczne
    group_name: "Kierownicy_Wiecek"
    share_name: "Projekty_Wiecek"
    share_path: "F:\\Projekty"

  tasks:

    # -------------------------------------------------------------------
    # ZADANIE 1: Konfiguracja Puli Dyskowej, Tieringu i Woluminu (F:)
  
    # Używamy PowerShell, ponieważ natywne moduły Ansible mają ograniczone
    # wsparcie dla Storage Tiering i Storage Spaces w konfiguracji mieszanej.
    # -------------------------------------------------------------------
    - name: Konfiguracja Storage Pool, Tiering (SSD/HDD) i Woluminu ReFS F
      ansible.windows.win_shell: |
        # Sprawdzenie czy dysk F już istnieje (idempotentność)
        if (Get-Volume -DriveLetter F -ErrorAction SilentlyContinue) {
            Write-Host "Wolumin F: już istnieje. Pomijam konfigurację."
            Exit 0
        }

        # Pobranie dostępnych dysków fizycznych
        $disks = Get-PhysicalDisk -CanPool $true

        if ($disks.Count -lt 4) {
            Write-Error "Znaleziono mniej niż 4 dyski do puli. Sprawdź konfigurację VM."
            Exit 1
        }

        # Utworzenie Puli
        $poolName = "StoragePool_Wiecek"
        New-StoragePool -FriendlyName $poolName -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks $disks | Out-Null

        # W środowisku wirtualnym typ mediów (SSD/HDD) często jest "Unspecified".
        # Poniższy fragment próbuje wymusić wykrycie lub ustawić tiery, jeśli media są rozpoznane.
        # W prostym labie wirtualnym bez S2D, tiering może wymagać ręcznego tagowania mediów.
        # Poniżej standardowa procedura tworzenia wirtualnego dysku z Mirrorem.
        
        # Utworzenie wirtualnego dysku (Mirror) wykorzystującego całą przestrzeń
        # UWAGA: Pełny Tiering SSD/HDD wymaga, aby hypervisor poprawnie zgłaszał typy dysków.
        $vDisk = New-VirtualDisk -StoragePoolFriendlyName $poolName `
                                 -FriendlyName "DataDisk" `
                                 -ResiliencySettingName Mirror `
                                 -UseMaximumSize `
                                 -ProvisioningType Fixed

        # Inicjalizacja, partycjonowanie i formatowanie ReFS jako F:
        $vDisk | Initialize-Disk -PartitionStyle GPT -PassThru | `
                 New-Partition -DriveLetter F -UseMaximumSize | `
                 Format-Volume -FileSystem ReFS -NewFileSystemLabel "Data" -Confirm:$false
      register: storage_result
      changed_when: "'Wolumin F: już istnieje' not in storage_result.stdout"

    # -------------------------------------------------------------------
    # ZADANIE 2: Zarządzanie Użytkownikami i Grupami
   
    # -------------------------------------------------------------------
    - name: Utwórz użytkownika Marek Romanek
      ansible.windows.win_user:
        name: "Marek Romanek"
        password: "Password123!" # Zalecane użycie Ansible Vault w produkcji
        state: present
        groups: Users

    - name: Utwórz użytkownika Jacek Gula
      ansible.windows.win_user:
        name: "Jacek Gula"
        password: "Password123!"
        state: present
        groups: Users

    - name: Utwórz grupę zabezpieczeń '{{ group_name }}'
      ansible.windows.win_group:
        name: "{{ group_name }}"
        state: present
        description: "Grupa kierownikow projektu"

    - name: Dodaj użytkowników do grupy '{{ group_name }}'
      ansible.windows.win_group_membership:
        name: "{{ group_name }}"
        members:
          - "Marek Romanek"
          - "Jacek Gula"
        state: present

    # -------------------------------------------------------------------
    # ZADANIE 3: Katalogi i Udziały Sieciowe
    
    # -------------------------------------------------------------------
    - name: Utwórz katalog '{{ share_path }}' na dysku F
      ansible.windows.win_file:
        path: "{{ share_path }}"
        state: directory

    - name: Udostępnij katalog jako '{{ share_name }}' z uprawnieniami
      ansible.windows.win_share:
        name: "{{ share_name }}"
        path: "{{ share_path }}"
        list: yes
        full: "Administrators,{{ group_name }}" # Pełny dostęp dla Adminów i Kierowników
        read: "" # Brak dostępu dla innych (domyślnie Everyone ma read, tutaj usuwamy)
        state: present

    # Dodatkowe zabezpieczenie NTFS (oprócz uprawnień udziału, ważne są uprawnienia plików)
    - name: Ustaw uprawnienia NTFS dla katalogu Projekty
      ansible.windows.win_acl:
        path: "{{ share_path }}"
        user: "{{ group_name }}"
        rights: FullControl
        type: allow
        state: present

    # -------------------------------------------------------------------
    # ZADANIE 4: Instalacja Aplikacji (Winget)
    
    # -------------------------------------------------------------------
    - name: Zainstaluj aplikacje przez Winget (7zip, Firefox, BIND/dig)
      ansible.windows.win_shell: |
        $app = "{{ item.id }}"
        if (!(winget list -e --id $app)) {
            winget install --id $app -e --silent --accept-package-agreements --accept-source-agreements
        }
      loop:
        - { name: '7zip', id: '7zip.7zip' }
        - { name: 'Firefox', id: 'Mozilla.Firefox' }
        - { name: 'BIND Tools (dig)', id: 'ISC.BIND' } # Pakiet zawierający narzędzie dig
      register: winget_install
      changed_when: winget_install.stdout is search("Successfully installed")

    # -------------------------------------------------------------------
    # ZADANIE 5: Rejestr - Blokada usuwania drukarek
 
    # -------------------------------------------------------------------
    - name: Konfiguracja Rejestru - Zapobieganie usuwaniu drukarek
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers
        name: NoDeletePrinter
        data: 1
        type: dword
        state: present
      # Nota: Ta polityka systemowa blokuje usuwanie drukarek użytkownikom, 
      # ale system Windows domyślnie pozwala Administratorom ignorować to ustawienie,
      # co spełnia wymóg "tylko wszystkim użytkownikom nie posiadających uprawnień administracyjnych".
